{% extends 'base.html' %}
{% block title %}Todos los pagos{% endblock %}

{% block header %}
  <h1>Pagos (todas las cuotas)</h1>
  <a class="btn" href="{% url 'pagos:pendientes' %}">Ver pendientes</a>
  <a class="btn" href="{% url 'pagos:vencidos' %}">Ver vencidos</a>
{% endblock %}

{% block content %}
  <div class="card">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Persona</th>
            <th>Banco</th>
            <th>Cuota</th>
            <th>Vence</th>
            <th>Monto</th>
            {% if tc %}<th>Equivalente ({{ destino|default:"PEN" }})</th>{% endif %}
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>

        {# --- Caso A: viene pagos_ctx (pago, monto_equivalente) --- #}
        {% if pagos_ctx %}
          {% for p, monto_conv in pagos_ctx %}
            <tr>
              <td>{{ p.prestamo.persona.apellidos }}, {{ p.prestamo.persona.nombres }}</td>
              <td>{{ p.prestamo.banco }}</td>
              <td>{{ p.numero_cuota }}</td>
              <td>{{ p.fecha_vencimiento }}</td>
              <td>{{ p.monto }}</td>
              {% if tc %}<td>{{ monto_conv|floatformat:2 }}</td>{% endif %}
              <td>
                {% if p.estado == 'Pendiente' %}
                  <span class="badge badge-pendiente">Pendiente</span>
                {% elif p.estado == 'Vencido' %}
                  <span class="badge badge-vencido">Vencido</span>
                {% else %}
                  <span class="badge badge-pagado">Pagado</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="{% if tc %}7{% else %}6{% endif %}">No hay pagos registrados.</td></tr>
          {% endfor %}

        {# --- Caso B: viene pagos (queryset de Pago) --- #}
        {% elif pagos %}
          {% for p in pagos %}
            <tr>
              <td>{{ p.prestamo.persona.apellidos }}, {{ p.prestamo.persona.nombres }}</td>
              <td>{{ p.prestamo.banco }}</td>
              <td>{{ p.numero_cuota }}</td>
              <td>{{ p.fecha_vencimiento }}</td>
              <td>{{ p.monto }}</td>
              {% if tc %}<td>{{ p.monto|floatformat:2 }}</td>{% endif %}
              <td>
                {% if p.estado == 'Pendiente' %}
                  <span class="badge badge-pendiente">Pendiente</span>
                {% elif p.estado == 'Vencido' %}
                  <span class="badge badge-vencido">Vencido</span>
                {% else %}
                  <span class="badge badge-pagado">Pagado</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="{% if tc %}7{% else %}6{% endif %}">No hay pagos registrados.</td></tr>
          {% endfor %}

        {# --- Sin datos --- #}
        {% else %}
          <tr><td colspan="{% if tc %}7{% else %}6{% endif %}">No hay pagos para mostrar.</td></tr>
        {% endif %}

        </tbody>
      </table>
    </div>
  </div>
{% endblock %}
