{% extends 'base.html' %}
{% block title %}Reportes{% endblock %}

{% block header %}
  <h1>Dashboard de Reportes</h1>
  <p>Mes actual: {{ primer_dia }} a {{ ultimo_dia }}</p>
{% endblock %}

{% block content %}
  <div class="cards">
    <div class="card">
      <strong>Pendientes (global):</strong>
      <div style="font-size:24px;">{{ total_pendientes }}</div>
    </div>
    <div class="card">
      <strong>Vencidos (global):</strong>
      <div style="font-size:24px;">{{ total_vencidos }}</div>
    </div>
    <div class="card">
      <strong>Pagados en el mes:</strong>
      <div style="font-size:24px;">{{ total_pagados_mes }}</div>
    </div>
  </div>

  <form method="get" class="filters">
    <label>
      Persona:
      <select name="persona" onchange="this.form.submit">
        <option value="">(Todas)</option>
        {% for per in personas %}
          <option value="{{ per.id_persona }}" {% if persona_id == per.id_persona %}selected{% endif %}>
            {{ per.apellidos }}, {{ per.nombres }}
          </option>
        {% endfor %}
      </select>
    </label>

    <label>
      Préstamo:
      <select name="prestamo" onchange="this.form.submit()">
        <option value="">(Todos)</option>
        {% for pr in prestamos %}
          <option value="{{ pr.id_prestamo }}" {% if prestamo_id == pr.id_prestamo %}selected{% endif %}>
            {{ pr.persona.apellidos }}, {{ pr.persona.nombres }} – {{ pr.banco }}
          </option>
        {% endfor %}
      </select>
    </label>

    <label>
      Base:
      <select name="base" onchange="this.form.submit()">
        <option value="USD" {% if base == 'USD' %}selected{% endif %}>USD</option>
        <option value="PEN" {% if base == 'PEN' %}selected{% endif %}>PEN</option>
        <option value="EUR" {% if base == 'EUR' %}selected{% endif %}>EUR</option>
      </select>
    </label>

    <label>
      Destino:
      <select name="destino" onchange="this.form.submit()">
        <option value="PEN" {% if destino == 'PEN' %}selected{% endif %}>PEN</option>
        <option value="USD" {% if destino == 'USD' %}selected{% endif %}>USD</option>
        <option value="EUR" {% if destino == 'EUR' %}selected{% endif %}>EUR</option>
      </select>
    </label>

    <noscript><button type="submit" class="btn">Aplicar</button></noscript>
  </form>

  <p>Tipo de cambio ({{ base }}→{{ destino }}) hoy: <strong>{{ tc }}</strong></p>

  <div class="card">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Persona</th>
            <th>Banco</th>
            <th>Cuota</th>
            <th>Vence</th>
            <th>Monto ({{ base }})</th>
            <th>Equivalente ({{ destino }})</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          {% for p, m_base, m_dest in pagos_mes_ctx %}
            <tr>
              <td>{{ p.prestamo.persona.apellidos }}, {{ p.prestamo.persona.nombres }}</td>
              <td>{{ p.prestamo.banco }}</td>
              <td>{{ p.numero_cuota }}</td>
              <td>{{ p.fecha_vencimiento }}</td>
              <td>{{ m_base|floatformat:2 }}</td>
              <td>{{ m_dest|floatformat:2 }}</td>
              <td>
                {% if p.estado == 'Pendiente' %}
                  <span class="badge badge-pendiente">Pendiente</span>
                {% elif p.estado == 'Vencido' %}
                  <span class="badge badge-vencido">Vencido</span>
                {% else %}
                  <span class="badge badge-pagado">Pagado</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="7">No hay pagos para el mes con los filtros aplicados.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}
